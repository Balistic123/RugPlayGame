import{w as a}from"./Dc9Cd6uL.js";import{N as h,U as w}from"./pY7SPrgy.js";import{U as S}from"./CTHXnj9k.js";import"./BiLdCT7w.js";import{t as U}from"./BR_bh9L_.js";import"./DT6MbhOo.js";import{g as N}from"./BnkorlfL.js";const _="https://h5mfnx-8080.csb.app",A=_,E=5e3,O=5,W=100;let n=null,r=null,i="@global";const C=a([]),y=a([]),l=a(!1),m=a(!1),P=a({});let b=!1;const p=new Map,f=new Map;async function T(e="preview"){b||m.set(!0);try{const t=new URLSearchParams;e==="preview"?(t.set("limit","5"),t.set("minValue","1000")):t.set("limit","100");const o=await fetch(`/api/trades/recent?${t.toString()}`);if(o.ok){const{trades:s}=await o.json();e==="preview"?C.set(s):y.set(s)}b=!0}catch(t){console.error("Failed to load initial trades:",t)}finally{m.set(!1)}}function d(){r&&(clearTimeout(r),r=null)}function R(){d(),r=setTimeout(g,E)}function u(){return(n==null?void 0:n.readyState)===WebSocket.OPEN}function v(){return(n==null?void 0:n.readyState)===WebSocket.CONNECTING}function c(e){u()&&n.send(JSON.stringify(e))}function I(){c({type:"subscribe",channel:"trades:all"}),c({type:"subscribe",channel:"trades:large"}),c({type:"set_coin",coinSymbol:i})}function L(e){const t={...e.data,timestamp:Number(e.data.timestamp)};e.type==="live-trade"?C.update(o=>[t,...o.slice(0,O-1)]):e.type==="all-trades"&&y.update(o=>[t,...o.slice(0,W-1)])}function M(e){const t=p.get(i);t&&t(e)}function F(e){const t={coinSymbol:e.coinSymbol,currentPrice:e.currentPrice,marketCap:e.marketCap,change24h:e.change24h,volume24h:e.volume24h,poolCoinAmount:e.poolCoinAmount,poolBaseCurrencyAmount:e.poolBaseCurrencyAmount};P.update(s=>({...s,[e.coinSymbol]:t}));const o=f.get(e.coinSymbol);o&&o(t)}function D(e){try{const t=JSON.parse(e.data);switch(t.type){case"live-trade":case"all-trades":L(t);break;case"price_update":F(t);break;case"ping":c({type:"pong"});break;case"new_comment":case"comment_liked":M(t);break;case"notification":const o={id:Date.now(),type:t.notificationType,title:t.title,message:t.message,link:t.link,isRead:!1,createdAt:t.timestamp,data:t.amount?{amount:t.amount}:null};h.update(s=>[o,...s]),w.update(s=>s+1),U.success(t.title,{description:t.message,action:{label:"View",onClick:()=>{N("/notifications")}},duration:5e3});break;default:console.log("Unhandled message type:",t.type,t)}}catch(t){console.error("Failed to process WebSocket message:",t)}}function g(){u()||v()||(d(),n=new WebSocket(A),T(),n.onopen=()=>{console.log("WebSocket connected"),l.set(!0),d(),I(),S.subscribe(e=>{e!=null&&e.id&&u()&&(console.log("Setting user subscription for user:",e.id),n.send(JSON.stringify({type:"set_user",userId:String(e.id)})))})()},n.onmessage=D,n.onclose=e=>{console.log(`WebSocket disconnected. Code: ${e.code}`),l.set(!1),n=null,R()},n.onerror=e=>{console.error("WebSocket error:",e),l.set(!1)})}function B(e){i!==e&&i!=="@global"&&k(i),i=e,c({type:"set_coin",coinSymbol:e})}function J(){d(),n&&(n.close(),n=null),l.set(!1)}function V(e,t){p.set(e,t)}function x(e){p.delete(e)}function K(e,t){f.set(e,t)}function k(e){f.delete(e)}class X{connect(){g()}disconnect(){J()}setCoin(t){B(t)}subscribeToComments(t,o){V(t,o)}unsubscribeFromComments(t){x(t)}subscribeToPriceUpdates(t,o){K(t,o)}unsubscribeFromPriceUpdates(t){k(t)}loadInitialTrades(t="preview"){T(t)}setUser(t){n&&n.readyState===WebSocket.OPEN&&n.send(JSON.stringify({type:"set_user",userId:t}))}}typeof window<"u"&&S.subscribe(e=>{e!=null&&e.id&&$.setUser(e.id.toString())});const $=new X;export{y as a,l as b,C as c,m as i,T as l,$ as w};
