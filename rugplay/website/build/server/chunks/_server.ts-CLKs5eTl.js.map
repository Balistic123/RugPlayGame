{"version":3,"file":"_server.ts-CLKs5eTl.js","sources":["../../../.svelte-kit/adapter-node/entries/endpoints/api/settings/delete-account/_server.ts.js"],"sourcesContent":["import { a as auth } from \"../../../../../chunks/auth.js\";\nimport { e as error, j as json } from \"../../../../../chunks/index.js\";\nimport { d as db, k as accountDeletionRequest, u as user } from \"../../../../../chunks/index4.js\";\nimport { eq } from \"drizzle-orm\";\nasync function POST({ request }) {\n  const authSession = await auth.api.getSession({\n    headers: request.headers\n  });\n  if (!authSession?.user) {\n    throw error(401, \"Not authenticated\");\n  }\n  const userId = Number(authSession.user.id);\n  const body = await request.json();\n  const { confirmationText } = body;\n  if (confirmationText !== \"DELETE MY ACCOUNT\") {\n    throw error(400, \"Invalid confirmation text\");\n  }\n  try {\n    const existingRequest = await db.select().from(accountDeletionRequest).where(eq(accountDeletionRequest.userId, userId)).limit(1);\n    if (existingRequest.length > 0) {\n      throw error(409, \"Account deletion already requested\");\n    }\n    const scheduledDeletionAt = /* @__PURE__ */ new Date();\n    scheduledDeletionAt.setDate(scheduledDeletionAt.getDate() + 14);\n    await db.transaction(async (tx) => {\n      await tx.insert(accountDeletionRequest).values({\n        userId,\n        scheduledDeletionAt,\n        reason: \"User requested account deletion\"\n      });\n      await tx.update(user).set({\n        isBanned: true,\n        banReason: \"Account deletion requested - scheduled for \" + scheduledDeletionAt.toISOString(),\n        updatedAt: /* @__PURE__ */ new Date()\n      }).where(eq(user.id, userId));\n    });\n    return json({\n      success: true,\n      message: `Account deletion has been scheduled for ${scheduledDeletionAt.toLocaleDateString()}. Your account has been temporarily suspended. You can cancel this request by contacting support before the scheduled date.`,\n      scheduledDeletionAt: scheduledDeletionAt.toISOString()\n    });\n  } catch (e) {\n    if (e && typeof e === \"object\" && \"status\" in e) {\n      throw e;\n    }\n    console.error(\"Account deletion error:\", e);\n    throw error(500, \"Internal server error\");\n  }\n}\nexport {\n  POST\n};\n"],"names":[],"mappings":";;;;;;;;;;;;;;;;AAIA,eAAe,IAAI,CAAC,EAAE,OAAO,EAAE,EAAE;AACjC,EAAE,MAAM,WAAW,GAAG,MAAM,IAAI,CAAC,GAAG,CAAC,UAAU,CAAC;AAChD,IAAI,OAAO,EAAE,OAAO,CAAC;AACrB,GAAG,CAAC;AACJ,EAAE,IAAI,CAAC,WAAW,EAAE,IAAI,EAAE;AAC1B,IAAI,MAAM,KAAK,CAAC,GAAG,EAAE,mBAAmB,CAAC;AACzC;AACA,EAAE,MAAM,MAAM,GAAG,MAAM,CAAC,WAAW,CAAC,IAAI,CAAC,EAAE,CAAC;AAC5C,EAAE,MAAM,IAAI,GAAG,MAAM,OAAO,CAAC,IAAI,EAAE;AACnC,EAAE,MAAM,EAAE,gBAAgB,EAAE,GAAG,IAAI;AACnC,EAAE,IAAI,gBAAgB,KAAK,mBAAmB,EAAE;AAChD,IAAI,MAAM,KAAK,CAAC,GAAG,EAAE,2BAA2B,CAAC;AACjD;AACA,EAAE,IAAI;AACN,IAAI,MAAM,eAAe,GAAG,MAAM,EAAE,CAAC,MAAM,EAAE,CAAC,IAAI,CAAC,sBAAsB,CAAC,CAAC,KAAK,CAAC,EAAE,CAAC,sBAAsB,CAAC,MAAM,EAAE,MAAM,CAAC,CAAC,CAAC,KAAK,CAAC,CAAC,CAAC;AACpI,IAAI,IAAI,eAAe,CAAC,MAAM,GAAG,CAAC,EAAE;AACpC,MAAM,MAAM,KAAK,CAAC,GAAG,EAAE,oCAAoC,CAAC;AAC5D;AACA,IAAI,MAAM,mBAAmB,mBAAmB,IAAI,IAAI,EAAE;AAC1D,IAAI,mBAAmB,CAAC,OAAO,CAAC,mBAAmB,CAAC,OAAO,EAAE,GAAG,EAAE,CAAC;AACnE,IAAI,MAAM,EAAE,CAAC,WAAW,CAAC,OAAO,EAAE,KAAK;AACvC,MAAM,MAAM,EAAE,CAAC,MAAM,CAAC,sBAAsB,CAAC,CAAC,MAAM,CAAC;AACrD,QAAQ,MAAM;AACd,QAAQ,mBAAmB;AAC3B,QAAQ,MAAM,EAAE;AAChB,OAAO,CAAC;AACR,MAAM,MAAM,EAAE,CAAC,MAAM,CAAC,IAAI,CAAC,CAAC,GAAG,CAAC;AAChC,QAAQ,QAAQ,EAAE,IAAI;AACtB,QAAQ,SAAS,EAAE,6CAA6C,GAAG,mBAAmB,CAAC,WAAW,EAAE;AACpG,QAAQ,SAAS,kBAAkB,IAAI,IAAI;AAC3C,OAAO,CAAC,CAAC,KAAK,CAAC,EAAE,CAAC,IAAI,CAAC,EAAE,EAAE,MAAM,CAAC,CAAC;AACnC,KAAK,CAAC;AACN,IAAI,OAAO,IAAI,CAAC;AAChB,MAAM,OAAO,EAAE,IAAI;AACnB,MAAM,OAAO,EAAE,CAAC,wCAAwC,EAAE,mBAAmB,CAAC,kBAAkB,EAAE,CAAC,2HAA2H,CAAC;AAC/N,MAAM,mBAAmB,EAAE,mBAAmB,CAAC,WAAW;AAC1D,KAAK,CAAC;AACN,GAAG,CAAC,OAAO,CAAC,EAAE;AACd,IAAI,IAAI,CAAC,IAAI,OAAO,CAAC,KAAK,QAAQ,IAAI,QAAQ,IAAI,CAAC,EAAE;AACrD,MAAM,MAAM,CAAC;AACb;AACA,IAAI,OAAO,CAAC,KAAK,CAAC,yBAAyB,EAAE,CAAC,CAAC;AAC/C,IAAI,MAAM,KAAK,CAAC,GAAG,EAAE,uBAAuB,CAAC;AAC7C;AACA;;;;"}