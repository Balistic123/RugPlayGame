{"version":3,"file":"_server.ts-Ce2-YF4y.js","sources":["../../../.svelte-kit/adapter-node/entries/endpoints/api/settings/_server.ts.js"],"sourcesContent":["import { a as auth, b as uploadProfilePicture } from \"../../../../chunks/auth.js\";\nimport { e as error, j as json } from \"../../../../chunks/index.js\";\nimport { d as db, u as user } from \"../../../../chunks/index4.js\";\nimport { eq } from \"drizzle-orm\";\nimport { M as MAX_FILE_SIZE } from \"../../../../chunks/constants.js\";\nimport { i as isNameAppropriate } from \"../../../../chunks/moderation.js\";\nasync function validateInputs(name, bio, username, avatarFile) {\n  if (!name || !name.trim()) {\n    throw error(400, \"Display name is required\");\n  }\n  const trimmedName = name.trim();\n  if (trimmedName.length < 2) {\n    throw error(400, \"Display name must be at least 2 characters\");\n  }\n  if (trimmedName.length > 50) {\n    throw error(400, \"Display name must be 50 characters or less\");\n  }\n  if (!await isNameAppropriate(trimmedName)) {\n    throw error(400, \"Name contains inappropriate content\");\n  }\n  if (bio && bio.length > 160) {\n    throw error(400, \"Bio must be 160 characters or less\");\n  }\n  if (username && (username.length < 3 || username.length > 30)) {\n    throw error(400, \"Username must be between 3 and 30 characters\");\n  }\n  if (username) {\n    const alphanumericRegex = /^[a-z0-9_]+$/;\n    if (!alphanumericRegex.test(username)) {\n      throw error(400, \"Username must contain only lowercase letters, numbers, and underscores\");\n    }\n    const purelyNumericRegex = /^\\d+$/;\n    if (purelyNumericRegex.test(username)) {\n      throw error(400, \"Username cannot be purely numeric\");\n    }\n  }\n  if (username && !await isNameAppropriate(username)) {\n    throw error(400, \"Username contains inappropriate content\");\n  }\n  if (bio && !await isNameAppropriate(bio)) {\n    throw error(400, \"Bio contains inappropriate content\");\n  }\n  if (avatarFile && avatarFile.size > MAX_FILE_SIZE) {\n    throw error(400, \"Avatar file must be smaller than 1MB\");\n  }\n}\nasync function POST({ request }) {\n  const session = await auth.api.getSession({\n    headers: request.headers\n  });\n  if (!session?.user) {\n    throw error(401, \"Not authenticated\");\n  }\n  const formData = await request.formData();\n  let name = formData.get(\"name\")?.trim();\n  const bio = formData.get(\"bio\");\n  const username = formData.get(\"username\")?.toLowerCase().trim();\n  const avatarFile = formData.get(\"avatar\");\n  name = name?.trim().replace(/\\s+/g, \" \");\n  await validateInputs(name, bio, username, avatarFile);\n  const updates = {\n    name,\n    bio,\n    username,\n    updatedAt: /* @__PURE__ */ new Date()\n  };\n  if (avatarFile && avatarFile.size > 0) {\n    try {\n      const arrayBuffer = await avatarFile.arrayBuffer();\n      const key = await uploadProfilePicture(\n        session.user.id,\n        new Uint8Array(arrayBuffer),\n        avatarFile.type\n      );\n      updates.image = key;\n    } catch (e) {\n      console.error(\"Avatar upload failed, continuing without update:\", e);\n    }\n  }\n  await db.update(user).set(updates).where(eq(user.id, Number(session.user.id)));\n  return json({ success: true });\n}\nexport {\n  POST\n};\n"],"names":[],"mappings":"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"}