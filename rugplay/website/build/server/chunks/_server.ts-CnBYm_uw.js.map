{"version":3,"file":"_server.ts-CnBYm_uw.js","sources":["../../../.svelte-kit/adapter-node/entries/endpoints/api/promo/verify/_server.ts.js"],"sourcesContent":["import { a as auth } from \"../../../../../chunks/auth.js\";\nimport { e as error, j as json } from \"../../../../../chunks/index.js\";\nimport { d as db, p as promoCode, a as promoCodeRedemption, u as user } from \"../../../../../chunks/index4.js\";\nimport { eq, and, count } from \"drizzle-orm\";\nconst POST = async ({ request }) => {\n  const session = await auth.api.getSession({ headers: request.headers });\n  if (!session?.user) {\n    throw error(401, \"Not authenticated\");\n  }\n  const { code } = await request.json();\n  if (!code || typeof code !== \"string\" || code.trim().length === 0) {\n    return json({ error: \"Promo code is required\" }, { status: 400 });\n  }\n  const normalizedCode = code.trim().toUpperCase();\n  const userId = Number(session.user.id);\n  return await db.transaction(async (tx) => {\n    const [promoData] = await tx.select({\n      id: promoCode.id,\n      code: promoCode.code,\n      rewardAmount: promoCode.rewardAmount,\n      maxUses: promoCode.maxUses,\n      expiresAt: promoCode.expiresAt,\n      isActive: promoCode.isActive,\n      description: promoCode.description\n    }).from(promoCode).where(eq(promoCode.code, normalizedCode)).for(\"update\").limit(1);\n    if (!promoData) {\n      return json({ error: \"Invalid promo code\" }, { status: 400 });\n    }\n    if (!promoData.isActive) {\n      return json({ error: \"This promo code is no longer active\" }, { status: 400 });\n    }\n    if (promoData.expiresAt && /* @__PURE__ */ new Date() > promoData.expiresAt) {\n      return json({ error: \"This promo code has expired\" }, { status: 400 });\n    }\n    const [existingRedemption] = await tx.select({ id: promoCodeRedemption.id }).from(promoCodeRedemption).where(and(\n      eq(promoCodeRedemption.userId, userId),\n      eq(promoCodeRedemption.promoCodeId, promoData.id)\n    )).limit(1);\n    if (existingRedemption) {\n      return json({ error: \"You have already used this promo code\" }, { status: 400 });\n    }\n    if (promoData.maxUses !== null) {\n      const [{ totalUses }] = await tx.select({ totalUses: count() }).from(promoCodeRedemption).where(eq(promoCodeRedemption.promoCodeId, promoData.id));\n      if (totalUses >= promoData.maxUses) {\n        return json({ error: \"This promo code has reached its usage limit\" }, { status: 400 });\n      }\n    }\n    const [userData] = await tx.select({ baseCurrencyBalance: user.baseCurrencyBalance }).from(user).where(eq(user.id, userId)).for(\"update\").limit(1);\n    if (!userData) {\n      throw error(404, \"User not found\");\n    }\n    const currentBalance = Number(userData.baseCurrencyBalance || 0);\n    const rewardAmount = Number(promoData.rewardAmount);\n    const newBalance = currentBalance + rewardAmount;\n    await tx.update(user).set({\n      baseCurrencyBalance: newBalance.toFixed(8),\n      updatedAt: /* @__PURE__ */ new Date()\n    }).where(eq(user.id, userId));\n    await tx.insert(promoCodeRedemption).values({\n      userId,\n      promoCodeId: promoData.id,\n      rewardAmount: rewardAmount.toFixed(8)\n    });\n    return json({\n      success: true,\n      message: promoData.description || `Promo code redeemed! You received $${rewardAmount.toFixed(2)}`,\n      rewardAmount,\n      newBalance,\n      code: promoData.code\n    });\n  });\n};\nexport {\n  POST\n};\n"],"names":[],"mappings":"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"}