{"version":3,"file":"_server.ts-D-Ovw5dI.js","sources":["../../../.svelte-kit/adapter-node/entries/endpoints/api/market/_server.ts.js"],"sourcesContent":["import { j as json } from \"../../../../chunks/index.js\";\nimport { c as coin, d as db, u as user } from \"../../../../chunks/index4.js\";\nimport { eq, or, ilike, gte, between, lte, and, asc, desc, count } from \"drizzle-orm\";\nconst VALID_SORT_FIELDS = [\"marketCap\", \"currentPrice\", \"change24h\", \"volume24h\", \"createdAt\"];\nconst VALID_SORT_ORDERS = [\"asc\", \"desc\"];\nconst PRICE_FILTERS = {\n  ALL: \"all\",\n  UNDER_1: \"under1\",\n  BETWEEN_1_TO_10: \"1to10\",\n  BETWEEN_10_TO_100: \"10to100\",\n  OVER_100: \"over100\"\n};\nconst CHANGE_FILTERS = {\n  ALL: \"all\",\n  GAINERS: \"gainers\",\n  LOSERS: \"losers\",\n  HOT: \"hot\",\n  WILD: \"wild\"\n};\nconst PRICE_RANGES = {\n  ONE: \"1.00000000\",\n  TEN: \"10.00000000\",\n  HUNDRED: \"100.00000000\"\n};\nconst CHANGE_THRESHOLDS = {\n  ZERO: \"0.0000\",\n  MODERATE: \"10.0000\",\n  MODERATE_NEGATIVE: \"-10.0000\",\n  EXTREME: \"50.0000\",\n  EXTREME_NEGATIVE: \"-50.0000\"\n};\nasync function GET({ url }) {\n  const searchQuery = url.searchParams.get(\"search\") || \"\";\n  const sortBy = url.searchParams.get(\"sortBy\") || \"marketCap\";\n  const sortOrder = url.searchParams.get(\"sortOrder\") || \"desc\";\n  const priceFilter = url.searchParams.get(\"priceFilter\") || \"all\";\n  const changeFilter = url.searchParams.get(\"changeFilter\") || \"all\";\n  const page = parseInt(url.searchParams.get(\"page\") || \"1\");\n  const limit = parseInt(url.searchParams.get(\"limit\") || \"12\");\n  if (!VALID_SORT_FIELDS.includes(sortBy) || !VALID_SORT_ORDERS.includes(sortOrder)) {\n    return json({ error: \"Invalid sort parameters\" }, { status: 400 });\n  }\n  if (page < 1 || limit < 1 || limit > 100) {\n    return json({ error: \"Invalid pagination parameters\" }, { status: 400 });\n  }\n  if (!Object.values(PRICE_FILTERS).includes(priceFilter) || !Object.values(CHANGE_FILTERS).includes(changeFilter)) {\n    return json({ error: \"Invalid filter parameters\" }, { status: 400 });\n  }\n  try {\n    const conditions = [eq(coin.isListed, true)];\n    if (searchQuery) {\n      conditions.push(\n        or(\n          ilike(coin.name, `%${searchQuery}%`),\n          ilike(coin.symbol, `%${searchQuery}%`)\n        )\n      );\n    }\n    switch (priceFilter) {\n      case PRICE_FILTERS.UNDER_1:\n        conditions.push(lte(coin.currentPrice, PRICE_RANGES.ONE));\n        break;\n      case PRICE_FILTERS.BETWEEN_1_TO_10:\n        conditions.push(between(coin.currentPrice, PRICE_RANGES.ONE, PRICE_RANGES.TEN));\n        break;\n      case PRICE_FILTERS.BETWEEN_10_TO_100:\n        conditions.push(between(coin.currentPrice, PRICE_RANGES.TEN, PRICE_RANGES.HUNDRED));\n        break;\n      case PRICE_FILTERS.OVER_100:\n        conditions.push(gte(coin.currentPrice, PRICE_RANGES.HUNDRED));\n        break;\n    }\n    switch (changeFilter) {\n      case CHANGE_FILTERS.GAINERS:\n        conditions.push(gte(coin.change24h, CHANGE_THRESHOLDS.ZERO));\n        break;\n      case CHANGE_FILTERS.LOSERS:\n        conditions.push(lte(coin.change24h, CHANGE_THRESHOLDS.ZERO));\n        break;\n      case CHANGE_FILTERS.HOT:\n        conditions.push(\n          or(\n            gte(coin.change24h, CHANGE_THRESHOLDS.MODERATE),\n            lte(coin.change24h, CHANGE_THRESHOLDS.MODERATE_NEGATIVE)\n          )\n        );\n        break;\n      case CHANGE_FILTERS.WILD:\n        conditions.push(\n          or(\n            gte(coin.change24h, CHANGE_THRESHOLDS.EXTREME),\n            lte(coin.change24h, CHANGE_THRESHOLDS.EXTREME_NEGATIVE)\n          )\n        );\n        break;\n    }\n    const whereCondition = and(...conditions);\n    const orderFn = sortOrder === \"asc\" ? asc : desc;\n    const sortColumn = (() => {\n      switch (sortBy) {\n        case \"marketCap\":\n          return coin.marketCap;\n        case \"currentPrice\":\n          return coin.currentPrice;\n        case \"change24h\":\n          return coin.change24h;\n        case \"volume24h\":\n          return coin.volume24h;\n        case \"createdAt\":\n          return coin.createdAt;\n        default:\n          return coin.marketCap;\n      }\n    })();\n    const [[{ total }], coins] = await Promise.all([\n      db.select({ total: count() }).from(coin).where(whereCondition),\n      db.select({\n        symbol: coin.symbol,\n        name: coin.name,\n        icon: coin.icon,\n        currentPrice: coin.currentPrice,\n        marketCap: coin.marketCap,\n        volume24h: coin.volume24h,\n        change24h: coin.change24h,\n        createdAt: coin.createdAt,\n        creatorName: user.name\n      }).from(coin).leftJoin(user, eq(coin.creatorId, user.id)).where(whereCondition).orderBy(orderFn(sortColumn)).limit(limit).offset((page - 1) * limit)\n    ]);\n    const formattedCoins = coins.map((c) => ({\n      symbol: c.symbol,\n      name: c.name,\n      icon: c.icon,\n      currentPrice: Number(c.currentPrice),\n      marketCap: Number(c.marketCap),\n      volume24h: Number(c.volume24h),\n      change24h: Number(c.change24h),\n      createdAt: c.createdAt,\n      creatorName: c.creatorName\n    }));\n    return json({\n      coins: formattedCoins,\n      total: total || 0,\n      page,\n      limit,\n      totalPages: Math.ceil((total || 0) / limit)\n    });\n  } catch (e) {\n    console.error(\"Error fetching market data:\", e);\n    return json({ error: \"Failed to fetch market data\" }, { status: 500 });\n  }\n}\nexport {\n  GET\n};\n"],"names":[],"mappings":"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"}