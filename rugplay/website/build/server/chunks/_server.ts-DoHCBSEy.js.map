{"version":3,"file":"_server.ts-DoHCBSEy.js","sources":["../../../.svelte-kit/adapter-node/entries/endpoints/api/admin/promo/_server.ts.js"],"sourcesContent":["import { a as auth } from \"../../../../../chunks/auth.js\";\nimport { e as error, j as json } from \"../../../../../chunks/index.js\";\nimport { d as db, p as promoCode, a as promoCodeRedemption } from \"../../../../../chunks/index4.js\";\nimport { eq, count } from \"drizzle-orm\";\nconst POST = async ({ request }) => {\n  const session = await auth.api.getSession({ headers: request.headers });\n  if (!session?.user || !session.user.isAdmin) {\n    throw error(403, \"Admin access required\");\n  }\n  const { code, description, rewardAmount, maxUses, expiresAt } = await request.json();\n  if (!code || !rewardAmount) {\n    return json({ error: \"Code and reward amount are required\" }, { status: 400 });\n  }\n  const normalizedCode = code.trim().toUpperCase();\n  const userId = Number(session.user.id);\n  const [existingCode] = await db.select({ id: promoCode.id }).from(promoCode).where(eq(promoCode.code, normalizedCode)).limit(1);\n  if (existingCode) {\n    return json({ error: \"Promo code already exists\" }, { status: 400 });\n  }\n  const [newPromoCode] = await db.insert(promoCode).values({\n    code: normalizedCode,\n    description: description || null,\n    rewardAmount: Number(rewardAmount).toFixed(8),\n    maxUses: maxUses || null,\n    expiresAt: expiresAt ? new Date(expiresAt) : null,\n    createdBy: userId\n  }).returning();\n  return json({\n    success: true,\n    promoCode: {\n      id: newPromoCode.id,\n      code: newPromoCode.code,\n      description: newPromoCode.description,\n      rewardAmount: Number(newPromoCode.rewardAmount),\n      maxUses: newPromoCode.maxUses,\n      expiresAt: newPromoCode.expiresAt\n    }\n  });\n};\nconst GET = async ({ request }) => {\n  const session = await auth.api.getSession({ headers: request.headers });\n  if (!session?.user || !session.user.isAdmin) {\n    throw error(403, \"Admin access required\");\n  }\n  const rows = await db.select({\n    id: promoCode.id,\n    code: promoCode.code,\n    description: promoCode.description,\n    rewardAmount: promoCode.rewardAmount,\n    maxUses: promoCode.maxUses,\n    isActive: promoCode.isActive,\n    createdAt: promoCode.createdAt,\n    expiresAt: promoCode.expiresAt,\n    usedCount: count(promoCodeRedemption.id).as(\"usedCount\")\n  }).from(promoCode).leftJoin(promoCodeRedemption, eq(promoCode.id, promoCodeRedemption.promoCodeId)).groupBy(promoCode.id);\n  return json({\n    codes: rows.map((pc) => ({\n      ...pc,\n      rewardAmount: Number(pc.rewardAmount)\n    }))\n  });\n};\nexport {\n  GET,\n  POST\n};\n"],"names":[],"mappings":"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"}