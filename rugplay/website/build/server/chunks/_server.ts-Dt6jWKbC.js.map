{"version":3,"file":"_server.ts-Dt6jWKbC.js","sources":["../../../.svelte-kit/adapter-node/entries/endpoints/api/coin/_coinSymbol_/holders/_server.ts.js"],"sourcesContent":["import { e as error, j as json } from \"../../../../../../chunks/index.js\";\nimport { d as db, c as coin, g as userPortfolio, u as user } from \"../../../../../../chunks/index4.js\";\nimport { eq, desc } from \"drizzle-orm\";\nimport { v as validateSearchParams } from \"../../../../../../chunks/validation.js\";\nfunction calculateLiquidationValue(tokensToSell, poolCoinAmount, poolBaseCurrencyAmount) {\n  if (tokensToSell <= 0 || poolCoinAmount <= 0 || poolBaseCurrencyAmount <= 0) {\n    return 0;\n  }\n  const maxSellable = poolCoinAmount * 0.995;\n  const actualTokensToSell = Math.min(tokensToSell, maxSellable);\n  const k = poolCoinAmount * poolBaseCurrencyAmount;\n  const newPoolCoin = poolCoinAmount + actualTokensToSell;\n  const newPoolBaseCurrency = k / newPoolCoin;\n  const baseCurrencyReceived = poolBaseCurrencyAmount - newPoolBaseCurrency;\n  return Math.max(0, baseCurrencyReceived);\n}\nasync function GET({ params, url }) {\n  const coinSymbol = params.coinSymbol?.toUpperCase();\n  const validator = validateSearchParams(url.searchParams);\n  const limit = validator.getPositiveInt(\"limit\", 50);\n  if (!coinSymbol) {\n    throw error(400, \"Coin symbol is required\");\n  }\n  if (limit > 200) {\n    throw error(400, \"Limit cannot exceed 200\");\n  }\n  try {\n    const [coinData] = await db.select({\n      id: coin.id,\n      symbol: coin.symbol,\n      circulatingSupply: coin.circulatingSupply,\n      poolCoinAmount: coin.poolCoinAmount,\n      poolBaseCurrencyAmount: coin.poolBaseCurrencyAmount,\n      currentPrice: coin.currentPrice\n    }).from(coin).where(eq(coin.symbol, coinSymbol)).limit(1);\n    if (!coinData) {\n      throw error(404, \"Coin not found\");\n    }\n    const holders = await db.select({\n      userId: user.id,\n      username: user.username,\n      name: user.name,\n      image: user.image,\n      quantity: userPortfolio.quantity\n    }).from(userPortfolio).innerJoin(user, eq(userPortfolio.userId, user.id)).where(eq(userPortfolio.coinId, coinData.id)).orderBy(desc(userPortfolio.quantity)).limit(limit);\n    const totalCirculating = Number(coinData.circulatingSupply);\n    const poolCoinAmount = Number(coinData.poolCoinAmount);\n    const poolBaseCurrencyAmount = Number(coinData.poolBaseCurrencyAmount);\n    const processedHolders = holders.map((holder, index) => {\n      const quantity = Number(holder.quantity);\n      const percentage = totalCirculating > 0 ? quantity / totalCirculating * 100 : 0;\n      const liquidationValue = calculateLiquidationValue(quantity, poolCoinAmount, poolBaseCurrencyAmount);\n      return {\n        rank: index + 1,\n        userId: holder.userId,\n        username: holder.username,\n        name: holder.name,\n        image: holder.image,\n        quantity,\n        percentage,\n        liquidationValue\n      };\n    });\n    return json({\n      coinSymbol: coinData.symbol,\n      totalHolders: holders.length,\n      circulatingSupply: totalCirculating,\n      poolInfo: {\n        coinAmount: poolCoinAmount,\n        baseCurrencyAmount: poolBaseCurrencyAmount,\n        currentPrice: Number(coinData.currentPrice)\n      },\n      holders: processedHolders\n    });\n  } catch (e) {\n    if (e && typeof e === \"object\" && \"status\" in e) {\n      throw e;\n    }\n    console.error(\"Unexpected error in holders API:\", e);\n    throw error(500, \"Internal server error\");\n  }\n}\nexport {\n  GET\n};\n"],"names":[],"mappings":"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"}