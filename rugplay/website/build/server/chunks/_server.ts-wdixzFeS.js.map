{"version":3,"file":"_server.ts-wdixzFeS.js","sources":["../../../.svelte-kit/adapter-node/entries/endpoints/api/settings/data-download/_server.ts.js"],"sourcesContent":["import { a as auth } from \"../../../../../chunks/auth.js\";\nimport { e as error } from \"../../../../../chunks/index.js\";\nimport { d as db, u as user, t as transaction, c as coin, g as userPortfolio, i as predictionBet, h as predictionQuestion, f as comment, e as commentLike, a as promoCodeRedemption, p as promoCode, s as session } from \"../../../../../chunks/index4.js\";\nimport { eq, and, lte } from \"drizzle-orm\";\nasync function HEAD({ request }) {\n  const authSession = await auth.api.getSession({\n    headers: request.headers\n  });\n  if (!authSession?.user) {\n    throw error(401, \"Not authenticated\");\n  }\n  const userId = Number(authSession.user.id);\n  try {\n    const userExists = await db.select({ id: user.id }).from(user).where(eq(user.id, userId)).limit(1);\n    if (!userExists.length) {\n      throw error(404, \"User not found\");\n    }\n    const estimatedSize = 1024 * 50;\n    return new Response(null, {\n      headers: {\n        \"Content-Type\": \"application/json; charset=utf-8\",\n        \"Content-Disposition\": `attachment; filename=\"rugplay-data-${userId}-${(/* @__PURE__ */ new Date()).toISOString().split(\"T\")[0]}.json\"`,\n        \"Content-Length\": estimatedSize.toString(),\n        \"Cache-Control\": \"no-cache, no-store, must-revalidate\",\n        \"Pragma\": \"no-cache\",\n        \"Expires\": \"0\"\n      }\n    });\n  } catch (err) {\n    console.error(\"Data export HEAD error:\", err);\n    throw error(500, \"Failed to check export availability\");\n  }\n}\nasync function GET({ request }) {\n  const authSession = await auth.api.getSession({\n    headers: request.headers\n  });\n  if (!authSession?.user) {\n    throw error(401, \"Not authenticated\");\n  }\n  const userId = Number(authSession.user.id);\n  try {\n    const userData = await db.select().from(user).where(eq(user.id, userId)).limit(1);\n    if (!userData.length) {\n      throw error(404, \"User not found\");\n    }\n    const transactions = await db.select({\n      id: transaction.id,\n      coinId: transaction.coinId,\n      coinName: coin.name,\n      coinSymbol: coin.symbol,\n      type: transaction.type,\n      quantity: transaction.quantity,\n      pricePerCoin: transaction.pricePerCoin,\n      totalBaseCurrencyAmount: transaction.totalBaseCurrencyAmount,\n      timestamp: transaction.timestamp\n    }).from(transaction).leftJoin(coin, eq(transaction.coinId, coin.id)).where(eq(transaction.userId, userId));\n    const portfolio = await db.select({\n      coinId: userPortfolio.coinId,\n      coinName: coin.name,\n      coinSymbol: coin.symbol,\n      quantity: userPortfolio.quantity,\n      updatedAt: userPortfolio.updatedAt\n    }).from(userPortfolio).leftJoin(coin, eq(userPortfolio.coinId, coin.id)).where(eq(userPortfolio.userId, userId));\n    const predictionBets = await db.select({\n      id: predictionBet.id,\n      questionId: predictionBet.questionId,\n      question: predictionQuestion.question,\n      side: predictionBet.side,\n      amount: predictionBet.amount,\n      actualWinnings: predictionBet.actualWinnings,\n      createdAt: predictionBet.createdAt,\n      settledAt: predictionBet.settledAt\n    }).from(predictionBet).leftJoin(predictionQuestion, eq(predictionBet.questionId, predictionQuestion.id)).where(eq(predictionBet.userId, userId));\n    const comments = await db.select({\n      id: comment.id,\n      coinId: comment.coinId,\n      coinName: coin.name,\n      coinSymbol: coin.symbol,\n      content: comment.content,\n      likesCount: comment.likesCount,\n      createdAt: comment.createdAt,\n      updatedAt: comment.updatedAt,\n      isDeleted: comment.isDeleted\n    }).from(comment).leftJoin(coin, eq(comment.coinId, coin.id)).where(eq(comment.userId, userId));\n    const commentLikes = await db.select({\n      commentId: commentLike.commentId,\n      createdAt: commentLike.createdAt\n    }).from(commentLike).where(eq(commentLike.userId, userId));\n    const promoRedemptions = await db.select({\n      id: promoCodeRedemption.id,\n      promoCodeId: promoCodeRedemption.promoCodeId,\n      promoCode: promoCode.code,\n      rewardAmount: promoCodeRedemption.rewardAmount,\n      redeemedAt: promoCodeRedemption.redeemedAt\n    }).from(promoCodeRedemption).leftJoin(promoCode, eq(promoCodeRedemption.promoCodeId, promoCode.id)).where(eq(promoCodeRedemption.userId, userId));\n    const sessions = await db.select({\n      id: session.id,\n      expiresAt: session.expiresAt,\n      createdAt: session.createdAt,\n      ipAddress: session.ipAddress,\n      userAgent: session.userAgent\n    }).from(session).where(and(\n      eq(session.userId, userId),\n      lte(session.expiresAt, /* @__PURE__ */ new Date())\n    ));\n    const createdCoins = await db.select({\n      id: coin.id,\n      name: coin.name,\n      symbol: coin.symbol,\n      icon: coin.icon,\n      initialSupply: coin.initialSupply,\n      circulatingSupply: coin.circulatingSupply,\n      marketCap: coin.marketCap,\n      price: coin.currentPrice,\n      change24h: coin.change24h,\n      poolCoinAmount: coin.poolCoinAmount,\n      poolBaseCurrencyAmount: coin.poolBaseCurrencyAmount,\n      createdAt: coin.createdAt,\n      updatedAt: coin.updatedAt,\n      isListed: coin.isListed\n    }).from(coin).where(eq(coin.creatorId, userId));\n    const createdQuestions = await db.select().from(predictionQuestion).where(eq(predictionQuestion.creatorId, userId));\n    const exportData = {\n      exportInfo: {\n        userId,\n        exportedAt: (/* @__PURE__ */ new Date()).toISOString(),\n        dataType: \"complete_user_data\"\n      },\n      user: userData[0],\n      transactions,\n      portfolio,\n      predictionBets,\n      comments,\n      commentLikes,\n      promoCodeRedemptions: promoRedemptions,\n      sessions,\n      createdCoins,\n      createdQuestions\n    };\n    const jsonData = JSON.stringify(exportData, null, 2);\n    const dataSize = new TextEncoder().encode(jsonData).length;\n    return new Response(jsonData, {\n      headers: {\n        \"Content-Type\": \"application/json; charset=utf-8\",\n        \"Content-Disposition\": `attachment; filename=\"rugplay-data-${userId}-${(/* @__PURE__ */ new Date()).toISOString().split(\"T\")[0]}.json\"`,\n        \"Content-Length\": dataSize.toString(),\n        \"Cache-Control\": \"no-cache, no-store, must-revalidate\",\n        \"Pragma\": \"no-cache\",\n        \"Expires\": \"0\"\n      }\n    });\n  } catch (err) {\n    console.error(\"Data export error:\", err);\n    throw error(500, \"Failed to export user data\");\n  }\n}\nexport {\n  GET,\n  HEAD\n};\n"],"names":[],"mappings":"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"}