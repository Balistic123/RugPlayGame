{"version":3,"file":"amm-C9rVEa8K.js","sources":["../../../.svelte-kit/adapter-node/chunks/amm.js"],"sourcesContent":["import { d as db, b as priceHistory, t as transaction, c as coin, g as userPortfolio } from \"./index4.js\";\nimport { and, eq, gte } from \"drizzle-orm\";\nimport { c as createNotification } from \"./notification.js\";\nasync function calculate24hMetrics(coinId, currentPrice) {\n  const twentyFourHoursAgo = new Date(Date.now() - 24 * 60 * 60 * 1e3);\n  const [priceData] = await db.select({ price: priceHistory.price }).from(priceHistory).where(and(\n    eq(priceHistory.coinId, coinId),\n    gte(priceHistory.timestamp, twentyFourHoursAgo)\n  )).orderBy(priceHistory.timestamp).limit(1);\n  let change24h = 0;\n  if (priceData) {\n    const priceFrom24hAgo = Number(priceData.price);\n    if (priceFrom24hAgo > 0) {\n      change24h = (currentPrice - priceFrom24hAgo) / priceFrom24hAgo * 100;\n    }\n  }\n  const volumeData = await db.select({ totalBaseCurrencyAmount: transaction.totalBaseCurrencyAmount }).from(transaction).where(and(\n    eq(transaction.coinId, coinId),\n    gte(transaction.timestamp, twentyFourHoursAgo)\n  ));\n  const volume24h = volumeData.reduce((sum, tx) => sum + Number(tx.totalBaseCurrencyAmount), 0);\n  return { change24h: Number(change24h.toFixed(4)), volume24h: Number(volume24h.toFixed(4)) };\n}\nasync function executeSellTrade(tx, coinData, userId, quantity) {\n  const poolCoinAmount = Number(coinData.poolCoinAmount);\n  const poolBaseCurrencyAmount = Number(coinData.poolBaseCurrencyAmount);\n  const currentPrice = Number(coinData.currentPrice);\n  if (poolCoinAmount <= 0 || poolBaseCurrencyAmount <= 0) {\n    throw new Error(\"Liquidity pool is not properly initialized or is empty\");\n  }\n  const k = poolCoinAmount * poolBaseCurrencyAmount;\n  const newPoolCoin = poolCoinAmount + quantity;\n  const newPoolBaseCurrency = k / newPoolCoin;\n  const baseCurrencyReceived = poolBaseCurrencyAmount - newPoolBaseCurrency;\n  const newPrice = newPoolBaseCurrency / newPoolCoin;\n  if (baseCurrencyReceived <= 0 || newPoolBaseCurrency < 1) {\n    const fallbackValue = quantity * currentPrice;\n    return {\n      success: false,\n      fallbackValue,\n      newPrice: currentPrice,\n      priceImpact: 0\n    };\n  }\n  const priceImpact = (newPrice - currentPrice) / currentPrice * 100;\n  await tx.insert(transaction).values({\n    userId,\n    coinId: coinData.id,\n    type: \"SELL\",\n    quantity: quantity.toString(),\n    pricePerCoin: (baseCurrencyReceived / quantity).toString(),\n    totalBaseCurrencyAmount: baseCurrencyReceived.toString(),\n    timestamp: /* @__PURE__ */ new Date()\n  });\n  await tx.insert(priceHistory).values({\n    coinId: coinData.id,\n    price: newPrice.toString()\n  });\n  const metrics = await calculate24hMetrics(coinData.id, newPrice);\n  await tx.update(coin).set({\n    currentPrice: newPrice.toString(),\n    marketCap: (Number(coinData.circulatingSupply) * newPrice).toString(),\n    poolCoinAmount: newPoolCoin.toString(),\n    poolBaseCurrencyAmount: newPoolBaseCurrency.toString(),\n    change24h: metrics.change24h.toString(),\n    volume24h: metrics.volume24h.toString(),\n    updatedAt: /* @__PURE__ */ new Date()\n  }).where(eq(coin.id, coinData.id));\n  const isRugPull = priceImpact < -20 && baseCurrencyReceived > 1e3;\n  if (isRugPull) {\n    (async () => {\n      try {\n        const affectedUsers = await db.select({\n          userId: userPortfolio.userId,\n          quantity: userPortfolio.quantity\n        }).from(userPortfolio).where(eq(userPortfolio.coinId, coinData.id));\n        for (const holder of affectedUsers) {\n          if (holder.userId === userId) continue;\n          const holdingValue = Number(holder.quantity) * newPrice;\n          if (holdingValue > 10) {\n            await createNotification(\n              holder.userId.toString(),\n              \"RUG_PULL\",\n              \"Coin rugpulled!\",\n              `A coin you owned, ${coinData.name} (*${coinData.symbol}), crashed ${Math.abs(priceImpact).toFixed(1)}%!`,\n              `/coin/${coinData.symbol}`\n            );\n          }\n        }\n      } catch (error) {\n        console.error(\"Error sending rug pull notifications:\", error);\n      }\n    })();\n  }\n  return {\n    success: true,\n    baseCurrencyReceived,\n    newPrice,\n    priceImpact,\n    newPoolCoin,\n    newPoolBaseCurrency,\n    metrics\n  };\n}\nexport {\n  calculate24hMetrics as c,\n  executeSellTrade as e\n};\n"],"names":[],"mappings":"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"}