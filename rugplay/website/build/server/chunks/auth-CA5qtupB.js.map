{"version":3,"file":"auth-CA5qtupB.js","sources":["../../../.svelte-kit/adapter-node/chunks/auth.js"],"sourcesContent":["import { betterAuth } from \"better-auth\";\nimport { drizzleAdapter } from \"better-auth/adapters/drizzle\";\nimport { d as private_env, p as public_env } from \"./shared-server.js\";\nimport { d as db, j as schema } from \"./index4.js\";\nimport { S3Client, PutObjectCommand } from \"@aws-sdk/client-s3\";\nimport \"@aws-sdk/s3-request-presigner\";\nimport { P as PUBLIC_B2_REGION, a as PUBLIC_B2_ENDPOINT, b as PUBLIC_B2_BUCKET } from \"./public.js\";\nimport sharp from \"sharp\";\nimport { apiKey } from \"better-auth/plugins\";\nconst adjectives = [\"happy\", \"lucky\", \"sunny\", \"clever\", \"brave\", \"bright\", \"cool\", \"wild\", \"calm\", \"kind\"];\nconst nouns = [\"panda\", \"tiger\", \"whale\", \"eagle\", \"lion\", \"wolf\", \"bear\", \"fox\", \"deer\", \"seal\"];\nfunction generateUsername() {\n  const adj = adjectives[Math.floor(Math.random() * adjectives.length)];\n  const noun = nouns[Math.floor(Math.random() * nouns.length)];\n  const number = Math.floor(Math.random() * 9999);\n  return `${adj}_${noun}${number}`;\n}\nconst REDIS_URL = \"redis://localhost:6379\";\nconst PRIVATE_B2_KEY_ID = \"your_b2_key_id\";\nconst PRIVATE_B2_APP_KEY = \"your_b2_app_key\";\nconst OPENROUTER_API_KEY = \"your_openrouter_api_key\";\nconst MAX_SIZE = 128;\nconst WEBP_QUALITY = 50;\nasync function processImage(inputBuffer) {\n  try {\n    const image = sharp(inputBuffer, { animated: true });\n    const processedBuffer = await image.resize(MAX_SIZE, MAX_SIZE, {\n      fit: \"inside\",\n      withoutEnlargement: true\n    }).webp({\n      quality: WEBP_QUALITY,\n      effort: 6\n    }).toBuffer();\n    return {\n      buffer: processedBuffer,\n      contentType: \"image/webp\",\n      size: processedBuffer.length\n    };\n  } catch (error) {\n    console.error(\"Image processing failed:\", error);\n    throw new Error(\"Failed to process image\");\n  }\n}\nconst s3Client = new S3Client({\n  endpoint: PUBLIC_B2_ENDPOINT,\n  region: PUBLIC_B2_REGION,\n  credentials: {\n    accessKeyId: PRIVATE_B2_KEY_ID,\n    secretAccessKey: PRIVATE_B2_APP_KEY\n  },\n  forcePathStyle: true,\n  requestChecksumCalculation: \"WHEN_REQUIRED\",\n  responseChecksumValidation: \"WHEN_REQUIRED\"\n});\nasync function uploadProfilePicture(identifier, body, contentType) {\n  if (!contentType || !contentType.startsWith(\"image/\")) {\n    throw new Error(\"Invalid file type. Only images are allowed.\");\n  }\n  const allowedTypes = [\"image/jpeg\", \"image/jpg\", \"image/png\", \"image/gif\", \"image/webp\"];\n  if (!allowedTypes.includes(contentType.toLowerCase())) {\n    throw new Error(\"Unsupported image format. Only JPEG, PNG, GIF, and WebP are allowed.\");\n  }\n  const processedImage = await processImage(Buffer.from(body));\n  const key = `avatars/${identifier}.webp`;\n  const command = new PutObjectCommand({\n    Bucket: PUBLIC_B2_BUCKET,\n    Key: key,\n    Body: processedImage.buffer,\n    ContentType: processedImage.contentType,\n    ContentLength: processedImage.size\n  });\n  await s3Client.send(command);\n  return key;\n}\nasync function uploadCoinIcon(coinSymbol, body, contentType) {\n  if (!contentType || !contentType.startsWith(\"image/\")) {\n    throw new Error(\"Invalid file type. Only images are allowed.\");\n  }\n  const allowedTypes = [\"image/jpeg\", \"image/jpg\", \"image/png\", \"image/gif\", \"image/webp\"];\n  if (!allowedTypes.includes(contentType.toLowerCase())) {\n    throw new Error(\"Unsupported image format. Only JPEG, PNG, GIF, and WebP are allowed.\");\n  }\n  const processedImage = await processImage(Buffer.from(body));\n  const key = `coins/${coinSymbol.toLowerCase()}.webp`;\n  const command = new PutObjectCommand({\n    Bucket: PUBLIC_B2_BUCKET,\n    Key: key,\n    Body: processedImage.buffer,\n    ContentType: processedImage.contentType,\n    ContentLength: processedImage.size\n  });\n  await s3Client.send(command);\n  return key;\n}\nif (!private_env.GOOGLE_CLIENT_ID) throw new Error(\"GOOGLE_CLIENT_ID is not set\");\nif (!private_env.GOOGLE_CLIENT_SECRET) throw new Error(\"GOOGLE_CLIENT_SECRET is not set\");\nif (!public_env.PUBLIC_BETTER_AUTH_URL) throw new Error(\"PUBLIC_BETTER_AUTH_URL is not set\");\nconst auth = betterAuth({\n  baseURL: public_env.PUBLIC_BETTER_AUTH_URL,\n  secret: private_env.PRIVATE_BETTER_AUTH_SECRET,\n  appName: \"Rugplay\",\n  trustedOrigins: [\n    public_env.PUBLIC_BETTER_AUTH_URL,\n    \"http://rugplay.com\",\n    \"http://localhost:5173\"\n  ],\n  plugins: [\n    apiKey({\n      defaultPrefix: \"rgpl_\",\n      rateLimit: {\n        enabled: true,\n        timeWindow: 1e3 * 60 * 60 * 24,\n        // 1 day\n        maxRequests: 2e3\n        // 2000 requests per day\n      },\n      permissions: {\n        defaultPermissions: {\n          api: [\"read\"]\n        }\n      }\n    })\n  ],\n  database: drizzleAdapter(db, {\n    provider: \"pg\",\n    schema\n  }),\n  socialProviders: {\n    google: {\n      clientId: private_env.GOOGLE_CLIENT_ID,\n      clientSecret: private_env.GOOGLE_CLIENT_SECRET,\n      mapProfileToUser: async (profile) => {\n        const newUsername = generateUsername();\n        let s3ImageKey = null;\n        if (profile.picture) {\n          try {\n            const response = await fetch(profile.picture);\n            if (!response.ok) {\n              console.error(`Failed to fetch profile picture: ${response.statusText}`);\n            } else {\n              const blob = await response.blob();\n              const arrayBuffer = await blob.arrayBuffer();\n              s3ImageKey = await uploadProfilePicture(\n                profile.sub,\n                new Uint8Array(arrayBuffer),\n                blob.type || \"image/jpeg\"\n              );\n            }\n          } catch (error) {\n            console.error(\"Failed to upload profile picture during social login:\", error);\n          }\n        }\n        return {\n          name: profile.name,\n          email: profile.email,\n          image: s3ImageKey,\n          username: newUsername\n        };\n      }\n    }\n  },\n  user: {\n    additionalFields: {\n      username: { type: \"string\", required: true, input: false },\n      isAdmin: { type: \"boolean\", required: true, input: false },\n      isBanned: { type: \"boolean\", required: false, input: false },\n      banReason: { type: \"string\", required: false, input: false },\n      baseCurrencyBalance: { type: \"string\", required: false, input: false },\n      bio: { type: \"string\", required: false },\n      volumeMaster: { type: \"string\", required: false, input: false },\n      volumeMuted: { type: \"boolean\", required: false, input: false }\n    }\n  },\n  session: {\n    cookieCache: {\n      enabled: true,\n      maxAge: 60 * 5\n    }\n  },\n  advanced: {\n    database: {\n      generateId: false\n    }\n  }\n});\nexport {\n  OPENROUTER_API_KEY as O,\n  REDIS_URL as R,\n  auth as a,\n  uploadProfilePicture as b,\n  uploadCoinIcon as u\n};\n"],"names":[],"mappings":"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"}